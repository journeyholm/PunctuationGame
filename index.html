<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PunctuaQuest: The Tower of Marks (3D)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* General Styling */
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700&display=swap');

        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-color: #0f3460;
            --text-color: #e94560;
            --ui-border: #e94560;
            --success-color: #55b871;
            --error-color: #e74c3c;
            --font-pixel: 'VT323', monospace;
            --font-sans: 'Inter', sans-serif;
--ui-text: #ffffff;
    --text-accent: #00ffff; /* Cyber Cyan - higher visibility than pink for data */
    --text-outline: 2px 2px 0px #000000; /* Hard shadow for pixel font */
    --modal-bg: #1a1a2e;
        }

/* Replace your existing html and body CSS with this */
/* Replace html and body with this */
html, body {
    /* Deep space gradient that makes 3D objects pop */
    background: radial-gradient(circle at center, #1a1a3e 0%, #0d0d21 100%);
    color: var(--ui-text);
    font-family: var(--font-sans);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    margin: 0;
    overflow: hidden;
    touch-action: none;
}

#game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100vw; /* Fill the full viewport width */
    height: 100vh; /* Fill the full viewport height */
    padding: 5px; /* Minimal padding for edge-to-edge feel */
    box-sizing: border-box;
    gap: 10px;
}

#canvas-wrapper {
    position: relative;
    width: 100%; /* Take up all available width */
    max-width: 1600px; /* Massive increase from 1100px */
    height: 75vh; /* Primary focus: expanded vertical space */
    border: 4px solid var(--ui-border);
    border-radius: 12px;
    background-color: #000;
    box-shadow: 0 0 30px var(--ui-border-glow);
    flex-shrink: 1; /* Allows shrinking on small phones without breaking layout */
}
        
        /* Customize scrollbar for webkit browsers (Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 0px;  /* Remove scrollbar space */
background: radial-gradient(circle at center, #16213e 0%, #0d0d21 100%);        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        #grammarlin-sprite-modal {
            font-size: 8rem;
            animation: bob 3s infinite ease-in-out;
            text-shadow: 0 0 20px #ff00ff;
            margin-bottom: 1rem;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .top-ui-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            display: flex;
            gap: 10px;
        }

        .top-ui-button {
            background-color: var(--accent-color);
            color: var(--ui-text);
            border: 2px solid var(--ui-border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-family: var(--font-pixel);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* D-pad Overlay Styles */
        .d-pad-container {
             position: absolute;
             top: 10px;
             left: 10px;
             z-index: 20;
             display: block; /* Always visible */
        }
        
        .d-pad-overlay {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr); /* Added row for Interact button */
            gap: 2px;
            width: 100px; /* Smaller width */
        }
        
        .d-pad-overlay button {
            background-color: rgba(15, 52, 96, 0.5); /* More transparent */
            border: 1px solid var(--ui-border); /* Thinner border */
            color: white;
            border-radius: 6px;
            width: 32px; /* Smaller buttons */
            height: 32px;
            font-size: 1rem;
            cursor: pointer;
            touch-action: none; /* IMPORTANT: Prevents browser scroll/zoom actions */
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none; /* Prevent text selection */
        }
        
        #up-btn-ipad    { grid-column: 2; grid-row: 1; }
        #left-btn-ipad  { grid-column: 1; grid-row: 2; }
        #right-btn-ipad { grid-column: 3; grid-row: 2; }
        #down-btn-ipad  { grid-column: 2; grid-row: 3; }
        #interact-btn-ipad { 
            grid-column: 1 / span 3; 
            grid-row: 4; 
            width: 100% !important; /* Override fixed width */
            margin-top: 4px;
            font-size: 0.8rem !important;
        }


.ui-panel {
    background-color: var(--secondary-bg);
    border: 2px solid var(--ui-border);
    border-radius: 10px;
    padding: 1rem;
    width: 100%;
    max-width: 1600px; /* Keeps stats perfectly aligned with the game window */
    box-sizing: border-box;
    font-family: var(--font-pixel);
    flex-shrink: 0;
}

#game-stats-panel h2 {
    font-size: 1.2rem; /* Smaller header to prioritize the 3D world */
    margin: 0 0 5px 0;
    letter-spacing: 2px;
    color: var(--text-accent);
}

        #game-stats-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
.game-stat-item {
    font-size: 1.4rem;
    color: #cccccc; /* Subtle gray for labels */
}

.game-stat-item span {
    color: var(--text-accent); 
    font-weight: bold;
    font-size: 1.6rem;
}

        #keys-display {
            font-size: 2.5rem;
            letter-spacing: 0.5rem;
            color: var(--success-color);
        }
        
        /* Modal and Dialogue styling */
        .modal {
            position: fixed; /* Changed from absolute to fixed to cover full screen */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to sit on top of everything */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
/* Update this specific block in your CSS */
/* Replace your .modal-content with this */
.modal-content {
    background-color: var(--secondary-bg);
    border: 4px solid var(--ui-border);
    border-radius: 12px;
    padding: 2.5rem;
    text-align: left;
    font-family: var(--font-sans); 
    font-size: 1.25rem;
    line-height: 1.6;
    color: #ffffff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 1);
    max-height: 85vh; /* Limits height to fit screen */
    overflow-y: auto; /* FIX: Permanent scrollbar for long text */
    display: flex;
    flex-direction: column;
}

/* Add this to ensure the button is always visible at the bottom of the scroll */
#play-again-button {
    margin-top: 2rem;
    flex-shrink: 0;
}

.modal-content h2 {
    font-family: var(--font-pixel);
    font-size: 3rem;
    text-align: center;
    color: var(--text-color);
    text-shadow: var(--text-outline);
    margin-top: 0;
    text-transform: uppercase;
}

#dialogue-text, #question-text, #info-text {
    margin-bottom: 2rem;
    font-weight: 500;
    color: #f0f0f0; /* Off-white is often easier on the eyes than pure white */
}

#quiz-counter {
    font-family: var(--font-pixel);
    font-size: 1.4rem;
    color: var(--text-color);
    text-align: right;
    margin-bottom: 0.5rem;
    display: block;
}
        
        /* Webkit Scrollbar Styling for Modal Content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }
        .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--ui-border);
            border-radius: 4px;
        }
        
        /* Codex Styling */
        #codex-modal-content {
            display: flex;
            gap: 1rem;
            height: 80vh;
            font-size: 1.2rem;
        }
        #codex-list {
            width: 30%;
            border-right: 2px solid var(--ui-border);
            padding-right: 1rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--ui-border) var(--secondary-bg);
        }
        #codex-list::-webkit-scrollbar { width: 8px; }
        #codex-list::-webkit-scrollbar-track { background: var(--secondary-bg); }
        #codex-list::-webkit-scrollbar-thumb { background-color: var(--ui-border); border-radius: 4px; }

        #codex-content {
            width: 70%;
            text-align: left;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--ui-border) var(--secondary-bg);
        }
        #codex-content::-webkit-scrollbar { width: 8px; }
        #codex-content::-webkit-scrollbar-track { background: var(--secondary-bg); }
        #codex-content::-webkit-scrollbar-thumb { background-color: var(--ui-border); border-radius: 4px; }

        .codex-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
        }
        .codex-unlocked {
             background-color: var(--accent-color);
        }
        .codex-locked {
            color: #777;
            cursor: not-allowed;
        }
        #codex-content h3 { color: var(--text-color); }
        #codex-content p { margin-bottom: 1rem; }
        #codex-content ul { list-style-type: none; padding-left: 0; }
        #codex-content li { background-color: var(--primary-bg); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; }

        /* Master Puzzle Styling */
        #master-puzzle-text {
            line-height: 2.5;
            font-size: 1.2rem;
            text-align: left;
        }
        #puzzle-error-message {
            color: var(--error-color);
            min-height: 1.5em;
        }
        .puzzle-input {
            width: 4ch;
            height: 1.8rem;
            font-family: var(--font-pixel);
            font-size: 1.2rem;
            text-align: center;
            -moz-text-align-last: center;
            text-align-last: center;
            background-color: var(--primary-bg);
            color: var(--ui-text);
            border: 1px solid var(--ui-border);
            border-radius: 4px;
            margin: 0 4px;
            vertical-align: middle;
        }
         .puzzle-input.incorrect {
            border-color: var(--error-color);
            border-width: 2px;
            box-shadow: 0 0 8px var(--error-color);
        }

        .modal-content h2 {
            color: var(--text-color);
            margin-top: 0;
        }
        
        #quiz-counter {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .modal-content ul {
            text-align: left;
            list-style-position: inside;
        }
         .modal-content li {
            margin-bottom: 0.5rem;
        }

        #dialogue-text, #info-text {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        #question-text {
             margin-bottom: 1.5rem;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .modal-buttons button, button.primary-btn {
            background-color: var(--accent-color);
            color: var(--ui-text);
            border: 2px solid var(--ui-border);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-family: var(--font-pixel);
            font-size: 1.4rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            width: 100%;
            touch-action: manipulation; /* Improve touch response on mobile */
        }

        .modal-buttons button:hover, button.primary-btn:hover {
            background-color: var(--text-color);
            color: var(--primary-bg);
            transform: translateY(-2px);
        }
        
        button.secondary-btn {
            background-color: transparent;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            color: var(--ui-text);
        }
        
        #feedback-panel {
            font-size: 1.6rem;
            line-height: 1.5;
        }
        #feedback-panel.success { color: var(--success-color); }
        #feedback-panel.error { color: var(--error-color); }

        #win-screen {
            font-size: 1.2rem;
        }
        #win-screen h2 { color: var(--success-color); font-size: 2.5rem; }
        
        #perfect-run-bonus {
            color: gold;
            text-shadow: 0 0 5px gold;
        }
        #perfect-run-bonus h3 {
            font-size: 2rem;
            margin: 0;
        }

        .final-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2rem;
            margin-top: 1rem;
            font-size: 1.5rem;
        }

        #review-section {
            text-align: left;
            margin-top: 2rem;
            border-top: 2px solid var(--ui-border);
            padding-top: 1rem;
        }

        #review-section h3 {
            color: var(--text-color);
        }

        .review-item {
            margin-bottom: 1.5rem;
            background-color: var(--primary-bg);
            padding: 1rem;
            border-radius: 5px;
        }

        .review-item p { margin: 0.5rem 0; }
        .review-item .your-answer { color: var(--error-color); }
        .review-item .correct-answer { color: var(--success-color); }

#mobile-controls {
    display: none !important;
}

        /* Tablet/Mobile Media Query */
        @media (max-width: 1024px), (hover: none) and (pointer: coarse) {
            body {
                height: auto;
                padding: 0.5rem;
                display: block; /* Allow normal document flow on mobile */
                overflow-y: auto;
            }
            #game-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                /* Ensure container grows with content */
                margin-bottom: 50px; 
            }
            
            /* Force hide bottom controls for iPad */
            #mobile-controls {
                display: none !important;
            }
        }
        
        /* Always show the D-pad overlay regardless of device */
        .d-pad-container {
            display: block;
        }
        
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 180px;
        }
        
        .d-pad button {
            background-color: var(--accent-color);
            border: 2px solid var(--ui-border);
            color: white;
            border-radius: 8px;
        }
        #up-btn    { grid-column: 2; grid-row: 1; }
        #left-btn  { grid-column: 1; grid-row: 2; }
        #right-btn { grid-column: 3; grid-row: 2; }
        #down-btn  { grid-column: 2; grid-row: 3; }
        
        .action-buttons {
            margin-top: 10px;
        }

        #dialogue-text, #question-text, #info-text {
    margin-bottom: 2rem;
    font-weight: 500;
    color: #f0f0f0; /* Off-white is often gentler than pure white */
}

/* Ensure the quiz counter is distinct from the question */
#quiz-counter {
    font-family: var(--font-pixel);
    font-size: 1.4rem;
    color: var(--text-color);
    text-align: right;
    margin-bottom: 0.5rem;
    display: block;
}

/* Replace your existing #answer-options and button styles with these */
#answer-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
    width: 100%;
}

#answer-options button {
    background-color: var(--accent-color);
    color: #ffffff;
    border: 2px solid var(--ui-border);
    border-radius: 8px;
    padding: 1.2rem;
    font-family: var(--font-sans); /* Cleaner for reading complex ELA questions */
    font-size: 1.1rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 0px rgba(0, 0, 0, 0.3);
    text-shadow: 1px 1px 2px #000;
}

#answer-options button:hover {
    background-color: var(--text-color);
    transform: translateY(-2px);
    box-shadow: 0 6px 0px rgba(0, 0, 0, 0.4);
}

#answer-options button:active {
    transform: translateY(2px);
    box-shadow: 0 0px 0px transparent;
}

/* Style the Exit Quiz button to be less distracting */
#exit-quiz-button {
    margin-top: 15px;
    background: transparent;
    border: 1px solid #777;
    color: #999;
    font-size: 0.9rem;
    width: auto;
    align-self: center;
}
    </style>
</head>
<body>

    <div id="game-container">
        <div id="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            <div class="top-ui-buttons">
                <button id="codex-button" class="top-ui-button">Grammar Codex</button>
                <button id="instructions-button" class="top-ui-button">How to Play</button>
            </div>

            <!-- iPad D-pad Overlay -->
            <div class="d-pad-container">
                <div class="d-pad-overlay">
                    <button id="up-btn-ipad">â–²</button>
                    <button id="left-btn-ipad">â—„</button>
                    <button id="right-btn-ipad">â–º</button>
                    <button id="down-btn-ipad">â–¼</button>
                    <button id="interact-btn-ipad">E</button>
                </div>
            </div>
            
            <!-- All Modals -->
            <div id="dialogue-modal" class="modal"><div class="modal-content"><p id="dialogue-text"></p><div class="modal-buttons"><button id="talk-button">Attempt Quiz</button><button id="close-dialogue-button">Leave</button></div></div></div>
            <div id="question-modal" class="modal"><div class="modal-content"><div id="quiz-counter"></div><p id="question-text"></p><div id="answer-options" class="modal-buttons"></div><button id="exit-quiz-button" class="secondary-btn">Exit Quiz</button></div></div>
            <div id="feedback-modal" class="modal"><div class="modal-content"><p id="feedback-panel"></p><button id="close-feedback-button" class="primary-btn">Continue</button></div></div>
            <div id="win-modal" class="modal"><div class="modal-content" id="win-screen">
                <h2>Victory!</h2>
                <div id="perfect-run-bonus" style="display: none;">
                    <h3>MASTER PUNCTUATIONIST!</h3>
                    <p>+10,000 Perfect Run Bonus!</p>
                </div>
                <div class="final-stats">
                    <div>TIME: <span id="final-time"></span></div>
                    <div>SCORE: <span id="final-score"></span></div>
                    <div>BEST: <span id="best-score"></span></div>
                </div>
                <p>You defeated Grammarlin's chaos and restored order to the world! The greatest treasure is knowledge.</p>
                <div id="review-section">
                    <h3>Review Your Mistakes</h3>
                    <div id="review-content"></div>
                </div>
                <button id="play-again-button" class="primary-btn">Play Again</button>
            </div></div>
            <div id="info-modal" class="modal"><div class="modal-content"><p id="info-text"></p><button id="close-info-button" class="primary-btn">Got it!</button></div></div>
            <div id="level-select-modal" class="modal"><div class="modal-content"><p>Where would you like to travel?</p><div class="modal-buttons"><button id="goto-ground-button">To the Ground Level</button><button id="goto-sky-button">To the Sky Tower</button><button id="goto-depths-button">To the Depths of Grammar</button><button id="stay-button">Stay Here</button></div></div></div>
            <div id="instructions-modal" class="modal"><div class="modal-content"><h2>How to Play</h2><p>Welcome to PunctuaQuest!</p><ul><li><strong>The Story:</strong> A mischievous gremlin named Grammarlin has stolen the 12 Punctuation Marks, throwing the world into chaos! It's up to you to restore order.</li><li><strong>Goal:</strong> Pass all 12 quizzes to unlock the final door and win the game!</li><li><strong>Controls:</strong> Use <strong>Arrow Keys</strong> or <strong>W, A, S, D</strong> to move. Use the <strong>E</strong> key to interact.</li><li><strong>Collectibles:</strong> There are 9 hidden Golden Quills. Find them all for a big score bonus!</li></ul><button id="close-instructions-button" class="primary-btn">Let's Go!</button></div></div>
            <div id="codex-modal" class="modal">
                <div class="modal-content" id="codex-modal-content">
                    <div id="codex-list"></div>
                    <div id="codex-content"></div>
                </div>
                <button id="close-codex-button" class="primary-btn" style="position: absolute; bottom: 20px;">Close</button>
            </div>
            <div id="master-puzzle-modal" class="modal"><div class="modal-content">
                <div id="grammarlin-sprite-modal">ðŸ‘¿</div>
                <h2>Grammarlin's Final Challenge!</h2>
                <p>"So, you think you're clever, do you?" Grammarlin taunts. "Fix my masterpiece of chaos if you can!"</p>
                <p id="puzzle-error-message"></p>
                <div id="master-puzzle-text"></div>
                <div class="modal-buttons" style="margin-top: 2rem;">
                    <button id="submit-puzzle-button" class="primary-btn">Defeat Grammarlin!</button>
                </div>
            </div></div>
        </div>
        <div id="game-stats-panel" class="ui-panel">
            <h2>GAME STATS</h2>
            <div id="game-stats-display">
                <div class="game-stat-item">TIME: <span id="timer-display">00:00</span></div>
                <div class="game-stat-item">SCORE: <span id="score-display">0</span></div>
                <div class="game-stat-item">KEYS: <span id="keys-display">0 / 12</span></div>
                <div class="game-stat-item">QUILLS: <span id="quill-count">0 / 9</span></div>
            </div>
        </div>
<div id="mobile-controls">
    <div class="d-pad">
        <button id="up-btn">â–²</button>
        <button id="left-btn">â—„</button>
        <button id="right-btn">â–º</button>
        <button id="down-btn">â–¼</button>
    </div>
    <div class="action-buttons">
        <button id="interact-btn" class="action-btn primary-btn">Interact (E)</button>
    </div>
</div>
    </div>

<script>
// ===== CONFIGURATION =====
const TILE_SIZE = 10;
const TOTAL_QUILLS = 9;

const TILE_TYPES = {
    GROUND: 0, WATER: 1, TREE: 2, TOWER: 3, BRIDGE: 4, DOOR: 5,
    WALL: 6, CLOUD: 7, CHASM: 8, CRYSTAL: 9, GOLDEN_QUILL: 10, BOSS_FLOOR: 11
};

const MATERIALS = {
    [TILE_TYPES.CRYSTAL]: new THREE.MeshStandardMaterial({ 
        color: '#9b59b6', 
        emissive: '#4a235a', 
        roughness: 0.2, 
        transparent: true, 
        opacity: 0.8 
    }),
GOLDEN_QUILL: new THREE.MeshStandardMaterial({ 
        color: '#ffd700', emissive: '#ff9800', emissiveIntensity: 0.4, metalness: 1.0, roughness: 0.1 
    }),

[TILE_TYPES.GROUND]: new THREE.MeshStandardMaterial({ color: '#2d4a36', roughness: 0.8 }),
    [TILE_TYPES.WATER]: new THREE.MeshPhysicalMaterial({ 
        color: '#3498db', transmission: 0.5, thickness: 2, roughness: 0.1 
    }),
    TREE_TRUNK: new THREE.MeshLambertMaterial({ color: '#8B4513' }),
    TREE_LEAVES: new THREE.MeshLambertMaterial({ color: '#2d572c' }),
    [TILE_TYPES.TOWER]: new THREE.MeshStandardMaterial({ color: '#ecf0f1', roughness: 0.8 }),
    [TILE_TYPES.BRIDGE]: new THREE.MeshLambertMaterial({ color: '#a0522d' }),
    [TILE_TYPES.DOOR]: new THREE.MeshStandardMaterial({ color: '#f1c40f', metalness: 0.5, roughness: 0.4 }),
    [TILE_TYPES.WALL]: new THREE.MeshStandardMaterial({ color: '#7f8c8d', roughness: 0.9 }),
[TILE_TYPES.CLOUD]: new THREE.MeshStandardMaterial({ 
        color: '#ffffff', emissive: '#aabbee', emissiveIntensity: 0.2, transparent: true, opacity: 0.9 
    }),
        [TILE_TYPES.CHASM]: new THREE.MeshLambertMaterial({ color: '#111111' }),
[TILE_TYPES.CRYSTAL]: new THREE.MeshStandardMaterial({ 
        color: '#9b59b6', emissive: '#6a1b9a', emissiveIntensity: 0.5, roughness: 0.1 
    }),
        [TILE_TYPES.BOSS_FLOOR]: new THREE.MeshLambertMaterial({ color: '#4d1a49' }),
    GOLDEN_QUILL: new THREE.MeshStandardMaterial({ color: '#ffd700', emissive: '#ffc400', metalness: 0.8, roughness: 0.2 }),
    DEV_TRIGGER: new THREE.MeshStandardMaterial({ color: 0xff00ff, emissive: 0xaa00aa, transparent: true, opacity: 0 }),
    PLAYER_SKIN: new THREE.MeshLambertMaterial({ color: '#f0c27b' }),
    PLAYER_SHIRT: new THREE.MeshLambertMaterial({ color: '#e74c3c' }),
    PLAYER_PANTS: new THREE.MeshLambertMaterial({ color: '#34495e' })
};

const DATABASE = {
    levels: {
        ground: {
            map: [
                [2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 3, 0, 2, 0, 0, 0, 0, 2],
                [2, 0, 0, 10, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2],
                [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 2, 2, 2, 0, 0, 10, 0, 2, 2],
                [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [2, 10, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            ],
            startPos: { x: 2, y: 2 },
            background: 0x87ceeb
        },
        sky: {
             map: [
                [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                [8, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 7, 8],
                [8, 7, 3, 7, 8, 8, 8, 8, 8, 10, 8, 8, 8, 8, 8, 8, 8, 7, 7, 8],
                [8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8],
                [8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8],
                [8, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 7, 7, 8],
                [8, 7, 7, 10, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 7, 7, 8],
                [8, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 10, 7, 8],
                [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8]
            ],
            startPos: { x: 2, y: 2 },
            background: 0xadd8e6
        },
        depths: {
             map: [
                [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],
                [6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6],
                [6, 0, 3, 0, 0, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 0, 0, 0, 6],
                [6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6],
                [6, 0, 0, 0, 6, 6, 10, 6, 6, 0, 0, 6, 6, 10, 6, 6, 0, 0, 0, 6],
                [6, 0, 0, 0, 6, 6, 6, 6, 6, 0, 0, 6, 6, 6, 6, 6, 0, 0, 0, 6],
                [6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6],
                [6, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 6],
                [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6]
            ],
            startPos: { x: 2, y: 2 },
            background: 0x483d8b
        },
        boss: {
            map: [
                [8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                [8, 11, 11, 11, 11, 11, 11, 11, 11, 8],
                [8, 11, 11, 11, 11, 11, 11, 11, 11, 8],
                [8, 11, 11, 11, 11, 11, 11, 11, 11, 8],
                [8, 11, 11, 11, 11, 11, 11, 11, 11, 8],
                [8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
            ],
            startPos: { x: 4, y: 4 },
            background: 0x2c003e
        }
    },
    npcs: {
        lumberjack: { level: 'ground', pos: {x: 5, y: 2}, punctuation: 'period', dialogue: "Thank goodness you're here! A gremlin named Grammarlin stole the Period, and now I can't stop working everything is just one long run on sentence of chopping please help me restore order!" },
        builder: { level: 'ground', pos: {x: 7, y: 5}, punctuation: 'comma', dialogue: "It's a mess! Grammarlin took the Comma, and now ideas are crashing into each other. Without commas to separate things, I can't build properly. If you can prove your mastery, I can build that bridge for you."},
        guide: { level: 'ground', pos: {x: 12, y: 3}, punctuation: 'question_mark', dialogue: "A hero arrives. Grammarlin has stolen the Question Mark, and without it, no one can ask how to stop him! Your quest is vital. Prove you understand the power of questions to unlock this tower."},
        exclaimer: { level: 'ground', pos: {x: 2, y: 6}, punctuation: 'exclamation_point', dialogue: "This is a disaster! An emergency! Grammarlin stole the Exclamation Point, and now I can't show how serious this is! Please, you have to help!"},
        
        apostrophe: { level: 'sky', pos: {x: 1, y: 1}, punctuation: 'apostrophe', dialogue: "Grammarlin's chaos reigns. He's trying to steal everyone's possessions and break apart our contractions. Without the Apostrophe, our language loses its connections. You must prove you can protect it."},
        quotes: { level: 'sky', pos: {x: 18, y: 1}, punctuation: 'quotation_marks', dialogue: "I can no longer tell who is speaking. Grammarlin stole the Quotation Marks, and now voices are lost in a jumble. Show me you can capture their words, and you'll earn my trust."},
        semicolon: { level: 'sky', pos: {x: 1, y: 7}, punctuation: 'semicolon', dialogue: "Related ideas are drifting apart, lost in the sky. Grammarlin stole the Semicolon, the very link between strong thoughts. You must reunite them."},
        colon: { level: 'sky', pos: {x: 18, y: 7}, punctuation: 'colon', dialogue: "Behold, a problem! I can't introduce my important lists or explanations because Grammarlin stole the Colon. Show me you know what's to come, and I'll help your quest."},
        
        parentheses: { level: 'depths', pos: {x: 1, y: 1}, punctuation: 'parentheses', dialogue: "Shh... the world's extra thoughts and asides are vanishing. Grammarlin stole the Parentheses, leaving our language plain and without detail. Bring back that richness."},
        hyphen: { level: 'depths', pos: {x: 18, y: 1}, punctuation: 'hyphen', dialogue: "I am small, but mighty. Grammarlin's theft has caused well-built words to fall apart. Without the Hyphen, compound ideas crumble. You must join them once more."},
        ellipsis: { level: 'depths', pos: {x: 1, y: 7}, punctuation: 'ellipsis', dialogue: "Our thoughts keep getting cut off... our sentences trail into nothing... It's Grammarlin's doing. He stole the Ellipsis, leaving only suspense and confusion..."},
        brackets: { level: 'depths', pos: {x: 15, y: 7}, punctuation: 'brackets', dialogue: "It's impossible to clarify anything now. Grammarlin stole the Brackets, and now we can't add our own context [to explain how bad it is]. Please, restore our ability to clarify."},
    },
    questions: {
        period: [
            { q: "Which of these is a command that should end with a period?", o: ["Please take out the trash", "Did you take out the trash", "Wow, you took out the trash"], a: 0, f: "A mild command, or imperative sentence, ends with a period." },
            { q: "A period is used at the end of a ___ sentence.", o: ["declarative", "interrogative", "exclamatory"], a: 0, f: "A declarative sentence makes a statement and ends with a period." },
            { q: "Indirect questions, such as 'I wonder who that is', end with a...", o: ["period", "question mark", "comma"], a: 0, f: "Indirect questions report a question and end with a period." },
        ],
        comma: [
            { q: "Where should a comma be placed in: 'I like cooking my family and my pets'?", o: ["After 'cooking'", "After 'family'", "Both A and B"], a: 2, f: "Without commas, it sounds like you like to cook your family! Use commas to separate items in a list." },
            { q: "Which sentence correctly uses a comma after an introductory element?", o: ["After the movie we went home.", "After the movie, we went home.", "After, the movie we went home."], a: 1, f: "Place a comma after an introductory phrase, like 'After the movie'." },
            { q: "Which sentence correctly uses a comma for a direct address?", o: ["Let's eat Grandpa.", "Let's eat, Grandpa.", "Lets eat Grandpa."], a: 1, f: "Commas save lives! Use a comma to set off the name of a person you are speaking to directly." },
        ],
        question_mark: [
            { q: "Which sentence requires a question mark?", o: ["I wonder who is coming to the party", "Who is coming to the party", "He asked who was coming to the party"], a: 1, f: "Direct questions, which ask something outright, end with a question mark." },
            { q: "A sentence that asks a question is called...", o: ["interrogative", "declarative", "exclamatory"], a: 0, f: "Interrogative sentences ask a question and end with a question mark." },
            { q: "A tag question, like 'It's a nice day, isn't it', should end with a...", o: ["period", "question mark", "comma"], a: 1, f: "Tag questions turn a statement into a question." },
        ],
        exclamation_point: [
             { q: "Which sentence shows the most excitement and needs an exclamation point?", o: ["I'm so happy to see you", "I am happy to see you", "Are you happy to see me"], a: 0, f: "Exclamation points show excitement, surprise, or other strong emotions." },
             { q: "A sentence that shows strong feeling is called...", o: ["exclamatory", "declarative", "interrogative"], a: 0, f: "Exclamatory sentences end with an exclamation point." },
             { q: "Which of these is a command that shows urgency?", o: ["Watch out!", "Please be careful.", "Are you being careful?"], a: 0, f: "Strong commands use an exclamation point." },
        ],
        apostrophe: [
            { q: "Which sentence correctly shows possession for one girl?", o: ["The girls book", "The girl's book", "The girls' book"], a: 1, f: "For a singular possessive noun, add an apostrophe and then 's'." },
            { q: "What is the correct contraction for 'do not'?", o: ["Dont", "Do'nt", "Don't"], a: 2, f: "An apostrophe replaces the missing letter(s) in a contraction." },
            { q: "Which sentence correctly shows possession for multiple boys?", o: ["The boys' hats", "The boy's hats", "The boys hats"], a: 0, f: "For a plural noun ending in 's', just add an apostrophe after the 's'." },
        ],
        quotation_marks: [
            { q: "In the sentence 'Let's go to the park she said', where should quotation marks be placed?", o: ["Around 'Let's go'", "Around 'Let's go to the park'", "Around the entire sentence"], a: 1, f: "Quotation marks enclose the exact words someone says." },
            { q: "Where does the period go in this sentence?", o: ["'I'm tired'. she said", "'I'm tired,' she said.", "'I'm tired' she said."], a: 1, f: "Commas and periods almost always go inside the closing quotation mark." },
            { q: "Which title should be in quotation marks?", o: ["The book 'To Kill a Mockingbird'", "The movie 'Star Wars'", "The poem 'The Raven'"], a: 2, f: "Titles of long works like books and movies are italicized; short works use quotes." },
        ],
        semicolon: [
             { q: "A semicolon is most like a...", o: ["period", "comma", "question mark"], a: 0, f: "A semicolon can replace a period to join two closely related independent clauses (complete sentences)." },
             { q: "Which sentence correctly uses a semicolon?", o: ["I have a big test tomorrow; I can't go out tonight.", "I have a big test tomorrow; so I can't go out.", "I have a big test; and I can't go out."], a: 0, f: "Use a semicolon to connect two complete sentences without a coordinating conjunction." },
             { q: "You can use a semicolon to separate items in a list when...", o: ["the list is very long", "the items themselves contain commas", "the list is in a question"], a: 1, f: "For example: 'I visited Boston, Massachusetts; Paris, France; and Rome, Italy.'" },
        ],
        colon: [
             { q: "A colon is often used to introduce...", o: ["a list", "an opposing idea", "a question"], a: 0, f: "A colon signals that something important, like a list or explanation, is about to follow." },
             { q: "Which sentence uses a colon correctly?", o: ["You need these items: butter, milk, and eggs.", "You need: butter, milk, and eggs.", "You need butter, milk, and eggs."], a: 0, f: "Use a colon after a complete sentence to introduce a list." },
             { q: "A colon can be used to separate two independent clauses when...", o: ["the second clause explains or illustrates the first", "the clauses are very short", "the clauses are unrelated"], a: 0, f: "For example: 'He got what he worked for: a promotion.'" },
        ],
        parentheses: [
            { q: "Parentheses are used to...", o: ["Emphasize a word", "Enclose extra, non-essential information", "Indicate a person is speaking"], a: 1, f: "Information in parentheses can often be removed without changing the sentence's basic meaning." },
            { q: "If the information inside the parentheses is a complete sentence, where does the end punctuation go?", o: ["Inside the parentheses", "Outside the parentheses", "No punctuation is needed"], a: 0, f: "For example: 'He finally answered. (It had taken him five minutes to think.)'" },
            { q: "If a parenthetical is at the end of a larger sentence, where does the period go?", o: ["Inside the parentheses", "Outside the parentheses", "Before the parentheses"], a: 1, f: "For example: 'I'm going to the store (the one on Main Street).'" },
        ],
        hyphen: [
            { q: "Which phrase is correctly hyphenated?", o: ["A well behaved dog", "A well-behaved dog", "A well behaved-dog"], a: 1, f: "Use a hyphen to join two or more words serving as a single adjective before a noun." },
            { q: "Which number should be hyphenated when written as a word?", o: ["One hundred", "Thirty five", "Thirty-five"], a: 2, f: "Hyphenate compound numbers from twenty-one to ninety-nine." },
            { q: "Which sentence needs a hyphen?", o: ["She has a part time job.", "She has a part-time job.", "She has a parttime job."], a: 1, f: "'Part-time' acts as a single adjective describing the job." },
        ],
        ellipsis: [
             { q: "What does an ellipsis (...) indicate?", o: ["A long pause or omitted words", "A grammatical error", "The end of a question"], a: 0, f: "Ellipses are used to show hesitation, create suspense, or to shorten a direct quote." },
             { q: "An ellipsis consists of exactly ___ dots.", o: ["two", "three", "four"], a: 1, f: "The three dots of an ellipsis are a specific punctuation mark." },
             { q: "In formal writing, an ellipsis is most often used to...", o: ["make the writing seem more dramatic", "shorten a quoted passage", "end every sentence"], a: 1, f: "It shows the reader that some of the original text has been left out." },
        ],
        brackets: [
            { q: "Brackets [ ] are used to...", o: ["Add clarifying words into a quote", "Show that a sentence is very important", "Act as a substitute for commas"], a: 0, f: "Use brackets to insert your own words into a quote to add context or clarification." },
            { q: "What is the Latin word often seen in brackets to indicate an error in a quote?", o: ["sic", "et al.", "ibid."], a: 0, f: "'[sic]' tells the reader that an error or unusual spelling in the quote was part of the original text." },
            { q: "Brackets are different from parentheses because brackets are used...", o: ["by the author of the text", "by the person quoting the text", "for less important information"], a: 1, f: "Brackets show that someone other than the original author has added something to the text." },
        ]
    },
    // Restored the missing codex object
    codex: {
        period: {
            title: "The Period (.)",
            description: "The period is a powerful stop sign. It marks the end of a complete thought in a declarative (statement) or imperative (mild command) sentence.",
            examples: [
                "Declarative: The dog ran across the yard.",
                "Imperative: Please close the door.",
                "Abbreviation: Dr. Smith is here."
            ]
        },
        comma: {
            title: "The Comma (,)",
            description: "The comma is used to create pauses and separate ideas in a sentence. It's one of the most versatile marks!",
            examples: [
                "In a list: I need milk, eggs, and bread.",
                "After an intro phrase: After the game, we went for pizza.",
                "To separate clauses: She is very smart, and she is also very kind."
            ]
        },
        question_mark: {
            title: "The Question Mark (?)",
            description: "This mark signals a question. It is used at the end of an interrogative sentence, which asks something directly.",
            examples: [
                "Direct Question: What time is it?",
                "Tag Question: You're coming with us, aren't you?"
            ]
        },
        exclamation_point: {
            title: "The Exclamation Point (!)",
            description: "Use this to show strong emotion like excitement, surprise, or anger, or to give a forceful command.",
            examples: [
                "Excitement: We won the championship!",
                "Strong Command: Stop right there!"
            ]
        },
         apostrophe: {
            title: "The Apostrophe (')",
            description: "The apostrophe has two main jobs: to show that letters are missing in a contraction, and to show possession or ownership.",
            examples: [
                "Contraction: 'don't' (do not), 'it's' (it is)",
                "Singular Possession: The cat's toy.",
                "Plural Possession: The cats' toys."
            ]
        },
        quotation_marks: {
            title: 'Quotation Marks (" ")',
            description: "These marks are used to show the exact words someone said (a direct quote). They are also used for the titles of short works like poems, songs, and short stories.",
            examples: [
                "Direct Quote: The teacher said, \"Please open your books.\"",
                "Title of a Song: My favorite song is \"Bohemian Rhapsody.\""
            ]
        },
        semicolon: {
            title: "The Semicolon (;)",
            description: "The semicolon is like a super-comma. Its main job is to connect two closely related independent clauses (complete sentences) that are not joined by a conjunction like 'and' or 'but'.",
            examples: [
                "Connecting Clauses: The sun was setting; the sky turned brilliant orange.",
                "Complex Lists: We visited Boston, MA; Paris, France; and Rome, Italy."
            ]
        },
        colon: {
            title: "The Colon (:)",
            description: "A colon is an introduction. It signals that something important is about to follow, such as a list, a long quotation, or an explanation.",
            examples: [
                "Introducing a List: You will need three things: a pencil, paper, and an eraser.",
                "Explanation: He had one goal in life: to become a great writer."
            ]
        },
        parentheses: {
            title: "Parentheses ( )",
            description: "Parentheses are used to enclose extra information that is not essential to the main point of the sentence. It's like a little aside to the reader.",
            examples: [
                "Extra Info: The winner of the race (a senior from a nearby high school) was awarded a medal."
            ]
        },
        hyphen: {
            title: "The Hyphen (-)",
            description: "The hyphen is a joiner. It's used to connect words together to form compound words or adjectives.",
            examples: [
                "Compound Adjective: She is a well-behaved student.",
                "Compound Numbers: twenty-one, fifty-six"
            ]
        },
        ellipsis: {
            title: "The Ellipsis (...)",
            description: "An ellipsis (three dots) shows that words have been omitted from a quotation. It can also be used to show a pause, hesitation, or a thought trailing off.",
            examples: [
                "Omitted Words: \"Four score and seven years ago our fathers brought forth... a new nation...\"",
                "Trailing Thought: I wonder where she could be..."
            ]
        },
        brackets: {
            title: "Brackets [ ]",
            description: "Brackets are used to insert your own words into a quotation, usually to add clarification or context. They show that the inserted words were not part of the original quote.",
            examples: [
                "Clarification: \"She [the senator] voted against the bill.\"",
                "Indicating an Error: \"They went to there [sic] house.\""
            ]
        }
    },
    masterPuzzle: {
        textParts: [
            "Grammarlin's final taunt lies before you", " a scrambled mess. ", " Wow", " What a journey it", "s been", "", " he sneered", ". ", " You may have collected all the keys", ", a so called great achievement", ", but can you handle this", " a true test of a punctuation master", " I", " a master of mayhem", " doubt it", "."
        ],
        solution: [",", '"', "!", "'", ",", '"', '"', ",", ",", "-", "?", ",", ",", ".", '"'],
        options: [
            [',', ';', ':', '.', '-'],
            ['"', "'", '(', '[', '.'],
            ['!', '?', '.', ',', ';'],
            ["'", '"', ',', '-', '.'],
            [',', '.', ';', ':', '-'],
            ['"', "'", ')', ']', '.'],
            ['.', '?', '!', ',', ';'],
            ['"', "'", '(', '[', '.'],
            [',', '.', ';', ':', '-'],
            [',', '.', ';', ':', '-'],
            ['-', '...', ':', ';', '?'],
            ['?', '!', '.', ',', ';'],
            [',', '.', ';', ':', '-'],
            [',', '.', ';', ':', '-'],
            ['.', '?', '!', ',', ';'],
            ['"', "'", ')', ']', '.']
        ]
    }
};

let gameState = {
    player: { x: 3, y: 2, level: 'ground', dir: 'down' },
    inventory: { wood: 0, goldenQuills: 0 },
    completedQuizzes: [],
    unlockedCodexEntries: [],
    wrongAnswers: [],
    failedQuizzes: [],
    startTime: null,
    quizStartTime: null,
    score: 0,
    activeNPC: null,
    gameMode: 'explore',
    elevatorUnlocked: false,
    currentQuiz: null,
    masterPuzzleCompleted: false
};

// ===== 3D SETUP =====
const canvas = document.getElementById('gameCanvas');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, 16 / 9, 0.1, 1000);
// alpha: true is required to see the CSS Space and Lava backgrounds
const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
let playerMesh, grammarlinMesh, levelGroup = new THREE.Group(), collectiblesGroup = new THREE.Group(), clickableGroup = new THREE.Group();
scene.add(levelGroup, collectiblesGroup, clickableGroup);
// ADD THIS LINE HERE:
// Around line 664
let stars; 
let lavaFloor; 
let particles = [];


scene.add(levelGroup, collectiblesGroup, clickableGroup);

// ===== MODULES =====
const Models = {
    createPlayer: () => {
        const group = new THREE.Group();
        const head = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), MATERIALS.PLAYER_SKIN);
        head.position.y = 7;
        const body = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 2), MATERIALS.PLAYER_SHIRT);
        body.position.y = 2;
        const legL = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), MATERIALS.PLAYER_PANTS);
        legL.position.set(-1, -3, 0);
        const legR = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), MATERIALS.PLAYER_PANTS);
        legR.position.set(1, -3, 0);
        group.add(head, body, legL, legR);
        return group;
    },
    createNPC: (color) => {
        const group = new THREE.Group();
        const material = new THREE.MeshLambertMaterial({ color: color });
        const head = new THREE.Mesh(new THREE.SphereGeometry(2.5, 16, 16), material);
        head.position.y = 6;
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 2, 8, 8), material);
        body.position.y = 1;
        group.add(head, body);
        return group;
    },
    createQuill: () => {
        const quill = new THREE.Mesh(new THREE.ConeGeometry(2, 8, 8), MATERIALS.GOLDEN_QUILL);
        quill.rotation.z = Math.PI / 1.5;
        quill.position.y = 5;
        return quill;
    },
    createDevTrigger: () => {
        const geometry = new THREE.BoxGeometry(5, 5, 5);
        const mesh = new THREE.Mesh(geometry, MATERIALS.DEV_TRIGGER);
        mesh.name = 'dev-trigger';
        mesh.position.y = 2.5;
        return mesh;
    }
};

let runtimeLevels;

const World = {
    init: () => {
        runtimeLevels = JSON.parse(JSON.stringify(DATABASE.levels));
    },
    loadLevel: (levelId, preservePlayerPosition = false) => {
        while (levelGroup.children.length > 0) levelGroup.remove(levelGroup.children[0]);
        while (collectiblesGroup.children.length > 0) collectiblesGroup.remove(collectiblesGroup.children[0]);
        while (clickableGroup.children.length > 0) clickableGroup.remove(clickableGroup.children[0]);

        const levelData = runtimeLevels[levelId];
        if (!levelData) return;

        // ATMOSPHERE ENGINE: Maps themes to level IDs
        if (levelId === 'sky') {
            // 1. SKY TOWER: Space Theme
            document.body.style.background = "radial-gradient(circle at center, #1a1a3e 0%, #0d0d21 100%)";
            scene.background = null; // Transparent to see CSS
            if (stars) stars.visible = true;
            if (lavaFloor) lavaFloor.visible = false;
        } else if (levelId === 'depths') {
            // 2. DEPTHS OF GRAMMAR: Lava Theme (Center of Earth)
            document.body.style.background = "radial-gradient(circle at center, #600000 0%, #100000 100%)";
            scene.background = null; 
            if (stars) stars.visible = false;
            if (lavaFloor) {
                lavaFloor.visible = true; // FIX: Reveal the Molten Sea
                lavaFloor.material.emissiveIntensity = 0.8;
            }
        } else {
            // 3. GROUND LEVEL: Original Light Blue/Nature Theme
            document.body.style.background = "#1a1a2e"; 
            scene.background = new THREE.Color(levelData.background);
            if (stars) stars.visible = false;
            if (lavaFloor) lavaFloor.visible = false;
        }

        const map = levelData.map;
        levelGroup.add(new THREE.GridHelper(map[0].length * TILE_SIZE, map[0].length, 0xffffff, 0xffffff));
        
        for (let row = 0; row < map.length; row++) {
            for (let col = 0; col < map[row].length; col++) {
                const tileType = map[row][col];
                let mesh;
                const pos = { x: col * TILE_SIZE, y: 0, z: row * TILE_SIZE };
                
                if (tileType === TILE_TYPES.TREE) {
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, TILE_SIZE, 8), MATERIALS.TREE_TRUNK);
                    const leaves = new THREE.Mesh(new THREE.BoxGeometry(TILE_SIZE-2, TILE_SIZE-2, TILE_SIZE-2), MATERIALS.TREE_LEAVES);
                    leaves.position.y = TILE_SIZE;
                    mesh = new THREE.Group();
                    mesh.add(trunk, leaves);
                } else if ([TILE_TYPES.TOWER, TILE_TYPES.WALL, TILE_TYPES.CRYSTAL].includes(tileType)) {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(TILE_SIZE, TILE_SIZE * 1.5, TILE_SIZE), MATERIALS[tileType]);
                    pos.y = (TILE_SIZE * 1.5) / 2;
                } else if (tileType === TILE_TYPES.GOLDEN_QUILL) {
                    const quill = Models.createQuill();
                    quill.position.x = pos.x;
                    quill.position.z = pos.z;
                    quill.userData = { col, row };
                    collectiblesGroup.add(quill);
                } else if (tileType !== TILE_TYPES.GROUND && tileType !== TILE_TYPES.CHASM) {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(TILE_SIZE, 1, TILE_SIZE), MATERIALS[tileType]);
                }
                
                if (mesh) {
                    mesh.position.set(pos.x, pos.y, pos.z);
                    levelGroup.add(mesh);
                }
            }
        }
        
        for(const npcId in DATABASE.npcs) {
            const npc = DATABASE.npcs[npcId];
            if(npc.level === levelId) {
                const npcMesh = Models.createNPC(Math.random() * 0xffffff);
                npcMesh.position.set(npc.pos.x * TILE_SIZE, 0, npc.pos.y * TILE_SIZE);
                npcMesh.name = `npc-${npcId}`;
                levelGroup.add(npcMesh);
            }
        }

        if (levelId === 'ground') {
            const devTrigger = Models.createDevTrigger();
            devTrigger.position.x = 19 * TILE_SIZE;
            devTrigger.position.z = 0 * TILE_SIZE;
            clickableGroup.add(devTrigger);
        }

        if (!preservePlayerPosition) {
            const startPos = levelData.startPos;
            gameState.player.x = startPos.x;
            gameState.player.y = startPos.y;
            playerMesh.position.set(startPos.x * TILE_SIZE, 4, startPos.y * TILE_SIZE);
        }
    },
    getTile: (x, y) => {
        const map = runtimeLevels[gameState.player.level].map;
        if (map[y] && map[y][x] !== undefined) return map[y][x];
        return null;
    },
    isNpcAt: (x, y) => {
        for(const npcId in DATABASE.npcs) {
            const npc = DATABASE.npcs[npcId];
            if(npc.level === gameState.player.level && npc.pos.x === x && npc.pos.y === y) {
                return true;
            }
        }
        return false;
    },
    updateBridge: () => {
        runtimeLevels['ground'].map[4][8] = TILE_TYPES.BRIDGE;
        runtimeLevels['ground'].map[4][9] = TILE_TYPES.BRIDGE;
        World.loadLevel('ground', true);
    },
    collectQuill: (x, y) => {
        for (let i = 0; i < 15; i++) {
        const p = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.5, 0.5),
            new THREE.MeshBasicMaterial({ color: '#ffd700', transparent: true })
        );
        p.position.set(x * TILE_SIZE, 5, y * TILE_SIZE);
        p.userData.velocity = new THREE.Vector3((Math.random()-0.5), Math.random(), (Math.random()-0.5));
        scene.add(p);
        particles.push(p);
    }
    const currentLevel = gameState.player.level;
    const map = runtimeLevels[currentLevel].map;
        const baseTile = currentLevel === 'sky' ? TILE_TYPES.CLOUD : currentLevel === 'depths' ? TILE_TYPES.GROUND : TILE_TYPES.GROUND;
        map[y][x] = baseTile;
        
        const quillToRemove = collectiblesGroup.children.find(q => q.userData.col === x && q.userData.row === y);
        if (quillToRemove) {
            quillToRemove.visible = false;
        }

        gameState.inventory.goldenQuills++;
        gameState.score += 500;
        UI.showInfo("You found a Golden Quill! +500 points!");
    }
};

const Player = {
    init: () => {
        playerMesh = Models.createPlayer();
        scene.add(playerMesh);
    },
    move: (dx, dy) => {
        if (gameState.gameMode !== 'explore') return;
        const newX = gameState.player.x + dx;
        const newY = gameState.player.y + dy;

        if (dx === 1) gameState.player.dir = 'right';
        if (dx === -1) gameState.player.dir = 'left';
        if (dy === 1) gameState.player.dir = 'down';
        if (dy === -1) gameState.player.dir = 'up';
        
        const tile = World.getTile(newX, newY);
        const isSolid = [TILE_TYPES.TREE, TILE_TYPES.WALL, TILE_TYPES.CHASM].includes(tile);
        const isWater = tile === TILE_TYPES.WATER;
        const isNpc = World.isNpcAt(newX, newY);

        if (tile !== null && !isSolid && !isWater && !isNpc) {
            gameState.player.x = newX;
            gameState.player.y = newY;
            Player.checkTileAction();
        }
    },
    interact: () => {
        if (gameState.gameMode !== 'explore') return;
        const { x, y, level } = gameState.player;
        
        const neighbors = [ {dx:0, dy:1}, {dx:0, dy:-1}, {dx:1, dy:0}, {dx:-1, dy:0} ];
        for (const n of neighbors) {
            const checkX = x + n.dx;
            const checkY = y + n.dy;
            if (World.getTile(checkX, checkY) === TILE_TYPES.DOOR) {
                UI.checkWinCondition();
                return; 
            }
        }

        for (const npcId in DATABASE.npcs) {
            const npc = DATABASE.npcs[npcId];
            if (npc.level === level) {
                const dist = Math.abs(npc.pos.x - x) + Math.abs(npc.pos.y - y);
                if (dist <= 1) {
                    NPC.startInteraction(npcId);
                    return; 
                }
            }
        }
    },
    checkTileAction: () => {
        const { x, y } = gameState.player;
        const tileType = World.getTile(x, y);

        if (tileType === TILE_TYPES.TOWER && gameState.elevatorUnlocked) {
            UI.showLevelSelect();
        } else if (tileType === TILE_TYPES.GOLDEN_QUILL) {
            World.collectQuill(x, y);
        } else if (tileType === TILE_TYPES.DOOR) {
            UI.checkWinCondition();
        }
    }
};

const NPC = {
    startInteraction: (npcId) => {
        gameState.gameMode = 'dialogue';
        gameState.activeNPC = npcId;
        const npc = DATABASE.npcs[npcId];
        
        if (gameState.completedQuizzes.includes(npcId)) {
            UI.showDialogue("You've already passed my quiz. Well done!");
            document.getElementById('talk-button').style.display = 'none';
        } else {
            UI.showDialogue(npc.dialogue);
            document.getElementById('talk-button').style.display = 'block';
        }
    }
};

const initialGameState = JSON.parse(JSON.stringify(gameState));

const Game = {
    reset: () => {
        gameState = JSON.parse(JSON.stringify(initialGameState));
        World.init(); 
        gameState.startTime = Date.now();
        World.loadLevel('ground');
        UI.closeModals();
        UI.update();
    },
    startBossBattle: () => {
        // No boss battle - directly win
        UI.winGame();
    }
};

const UI = {
    update: () => {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('visible'));
        const modalId = {
            dialogue: 'dialogue-modal', 
            question: 'question-modal',
            feedback: 'feedback-modal', 
            won: 'win-modal', 
            modal: 'info-modal',
            codex: 'codex-modal',
            puzzle: 'master-puzzle-modal'
        }[gameState.gameMode];

        const statsPanel = document.getElementById('game-stats-panel');
        const mobileControls = document.getElementById('mobile-controls');
        const topButtons = document.querySelector('.top-ui-buttons');
        
        statsPanel.style.display = 'block';
        if(window.innerWidth <= 1024) mobileControls.style.display = 'flex'; // Adjusted breakpoint
        topButtons.style.display = 'flex';
        if (playerMesh) playerMesh.visible = true;

        if (modalId) {
            document.getElementById(modalId).classList.add('visible');
        }
    },
    showDialogue: (text) => {
        document.getElementById('dialogue-text').textContent = text;
        gameState.gameMode = 'dialogue';
        document.getElementById('talk-button').textContent = "Attempt Quiz";
        UI.update();
    },
    startQuiz: () => {
        const npcId = gameState.activeNPC;
        const npc = DATABASE.npcs[npcId];
        const questions = DATABASE.questions[npc.punctuation];

        if (!questions || questions.length < 3) {
            UI.showInfo("Something went wrong, I don't have enough questions!");
            return;
        }
        
        gameState.quizStartTime = Date.now();
        gameState.currentQuiz = {
            questions: questions,
            currentIdx: 0,
            correctCount: 0
        };
        UI.showQuizQuestion();
    },
    
showQuizQuestion: () => {
        if (!gameState.currentQuiz) return;
        const quiz = gameState.currentQuiz;
        const questionData = quiz.questions[quiz.currentIdx];
        
        gameState.gameMode = 'question';
        
        // Update header with "Quest" feel
        const counter = document.getElementById('quiz-counter');
        counter.textContent = `Punctuation Challenge: ${quiz.currentIdx + 1} of ${quiz.questions.length}`;
        
        document.getElementById('question-text').textContent = questionData.q;
        const optionsContainer = document.getElementById('answer-options');
        optionsContainer.innerHTML = '';

        // 1. Create a map of options that remembers their original index
        let choices = questionData.o.map((text, index) => {
            return { text: text, originalIndex: index };
        });

        // 2. Shuffle the choices array (Fisher-Yates)
        for (let i = choices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choices[i], choices[j]] = [choices[j], choices[i]];
        }

        // 3. Render the shuffled buttons
        choices.forEach((choice) => {
            const button = document.createElement('button');
            button.textContent = choice.text;
            // When clicked, it submits its ORIGINAL index so grading stays accurate
            button.onclick = () => UI.submitAnswer(choice.originalIndex);
            optionsContainer.appendChild(button);
        });
        
        document.getElementById('close-feedback-button').onclick = UI.nextQuizQuestion;
        UI.update();
    },

    submitAnswer: (answerIndex) => {
        const quiz = gameState.currentQuiz;
        const questionData = quiz.questions[quiz.currentIdx];
        
        const isCorrect = (answerIndex === questionData.a);
        let feedbackText;
        
        if(isCorrect) {
            feedbackText = `CORRECT! ${questionData.f}`;
            quiz.correctCount++;
        } else {
            feedbackText = `Not quite. ${questionData.f}`;
            const alreadyLogged = gameState.wrongAnswers.some(wa => wa.q === questionData.q);
            if (!alreadyLogged) {
                gameState.wrongAnswers.push({
                    q: questionData.q,
                    yourAnswer: questionData.o[answerIndex],
                    correctAnswer: questionData.o[questionData.a],
                    explanation: questionData.f
                });
            }
        }
        
        gameState.gameMode = 'feedback';
        const feedbackPanel = document.getElementById('feedback-panel');
        feedbackPanel.textContent = feedbackText;
        feedbackPanel.className = isCorrect ? 'success' : 'error';
        UI.update();
    },
    nextQuizQuestion: () => {
        const quiz = gameState.currentQuiz;
        if (!quiz) {
            UI.closeModals();
            return;
        }

        quiz.currentIdx++;
        if (quiz.currentIdx < quiz.questions.length) {
            UI.showQuizQuestion();
        } else {
            UI.endQuiz();
        }
    },
    endQuiz: () => {
        const quiz = gameState.currentQuiz;
        const npcId = gameState.activeNPC;
        if (quiz.correctCount === quiz.questions.length) {
            gameState.completedQuizzes.push(npcId);
            UI.handleQuizSuccess();
        } else {
            if (!gameState.failedQuizzes.includes(npcId)) {
                gameState.failedQuizzes.push(npcId);
            }
            UI.showInfo(`You answered ${quiz.correctCount} out of 3 questions correctly. You must get all 3 right in one attempt to earn the reward. Please try again!`);
        }
        gameState.currentQuiz = null;
        gameState.quizStartTime = null;
        document.getElementById('close-info-button').onclick = UI.closeModals;
    },
    handleQuizSuccess: () => {
        const npcId = gameState.activeNPC;
        const punctuationType = DATABASE.npcs[npcId].punctuation;
        if (!gameState.unlockedCodexEntries.includes(punctuationType)) {
            gameState.unlockedCodexEntries.push(punctuationType);
        }

        let successMessage = "Excellent! You answered all questions correctly. ";
        
        const quizTimeSec = Math.floor((Date.now() - gameState.quizStartTime) / 1000);
        const timeBonus = Math.max(100 - (quizTimeSec * 5), 0);
        gameState.score += 1000 + timeBonus;
        successMessage += `You earned a time bonus of ${timeBonus} points! `;

        switch(punctuationType) {
            case 'period':
                gameState.inventory.wood = 3;
                successMessage += "You received 3 wood for the bridge!";
                break;
            case 'comma':
                if (gameState.inventory.wood >= 3) {
                    gameState.inventory.wood = 0;
                    World.updateBridge();
                    successMessage += "You used your wood to build the bridge!";
                } else {
                    gameState.completedQuizzes = gameState.completedQuizzes.filter(id => id !== npcId);
                    successMessage = "Correct! But you need 3 wood. Find the Lumberjack first.";
                }
                break;
            case 'question_mark':
                gameState.elevatorUnlocked = true;
                successMessage += "The Tower Elevator is now unlocked!";
                break;
            default:
                successMessage += `You have mastered the ${punctuationType.replace('_', ' ')}! Its entry is now unlocked in the Codex.`;
        }
        
        UI.showInfo(successMessage);
        if (gameState.completedQuizzes.length >= 12) {
            UI.showInfo("You have mastered all 12 marks! Walk into the final door in the Depths to claim your victory!");
        }
    },
    closeModals: () => {
        gameState.gameMode = 'explore';
        gameState.activeNPC = null;
        gameState.currentQuiz = null;
        gameState.quizStartTime = null;
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('visible'));
    },
    updateUI: () => {
        const elapsed = Date.now() - gameState.startTime;
        const seconds = Math.floor(elapsed / 1000) % 60;
        const minutes = Math.floor(elapsed / (1000 * 60));
        document.getElementById('timer-display').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        document.getElementById('score-display').textContent = gameState.score;
        document.getElementById('keys-display').textContent = `${gameState.completedQuizzes.length} / 12`;
        document.getElementById('quill-count').textContent = `${gameState.inventory.goldenQuills} / ${TOTAL_QUILLS}`;
    },
    checkWinCondition: () => {
        if (gameState.completedQuizzes.length >= 12) {
             // UI.winGame(); - REMOVE THIS from here
             // Instead of winning immediately on touch, start the boss battle
             Game.startBossBattle(); 
        } else {
             UI.showInfo(`The Door of Expression is sealed. You need to pass all 12 quizzes. You have only completed ${gameState.completedQuizzes.length}.`);
        }
    },
    startMasterPuzzle: () => {
        // Kept for compatibility but not used
    },
    submitMasterPuzzle: () => {
        // Kept for compatibility but not used
    },
winGame: () => {
    gameState.gameMode = 'won';
    const finalTimeMs = Date.now() - gameState.startTime;
    const finalTimeSec = Math.floor(finalTimeMs / 1000);

    // Calculate score logic
    const timePenalty = finalTimeSec * 2;
    let finalScore = Math.max(Math.round(gameState.score - timePenalty), 0);
    if (gameState.inventory.goldenQuills === TOTAL_QUILLS) finalScore += 5000;
    
    const perfectRun = gameState.failedQuizzes.length === 0;
    if (perfectRun) finalScore += 10000;

    // 1. Update text content
    document.getElementById('final-time').textContent = document.getElementById('timer-display').textContent;
    document.getElementById('final-score').textContent = finalScore;
    
    const bestScore = localStorage.getItem('punctuaQuestBestScore') || 0;
    if (finalScore > bestScore) {
        localStorage.setItem('punctuaQuestBestScore', finalScore);
        document.getElementById('best-score').textContent = `${finalScore} (NEW RECORD!)`;
    } else {
        document.getElementById('best-score').textContent = bestScore;
    }

    // 2. Build the Stylized Mastery Checklist
    const reviewContent = document.getElementById('review-content');
    reviewContent.innerHTML = `<h3 style="color: var(--text-accent); text-align: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 10px;">MARKS OF THE MASTER</h3>`;
    
    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
    grid.style.gap = '8px';
    grid.style.margin = '20px 0';

    const allMarks = ['Period', 'Comma', 'Question Mark', 'Exclamation Point', 'Apostrophe', 'Quotes', 'Semicolon', 'Colon', 'Parentheses', 'Hyphen', 'Ellipsis', 'Brackets'];
    
    allMarks.forEach(mark => {
        const item = document.createElement('div');
        item.style.fontSize = '1rem';
        item.style.background = 'rgba(15, 52, 96, 0.4)';
        item.style.padding = '8px';
        item.style.borderRadius = '6px';
        item.innerHTML = `âœ… <span style="color: #55b871;">${mark}</span>`;
        grid.appendChild(item);
    });
    reviewContent.appendChild(grid);

    // 3. Add Personalized Teacher Message
    const msg = document.createElement('div');
    msg.style.padding = '15px';
    msg.style.borderLeft = '4px solid var(--ui-border)';
    msg.style.background = 'rgba(233, 69, 96, 0.1)';
    msg.style.marginBottom = '20px';
    
    if (perfectRun) {
        msg.innerHTML = `<strong>MASTER PUNCTUATIONIST:</strong> Grammarlin stands defeated! You restored order without a single mistake.`;
        document.getElementById('perfect-run-bonus').style.display = 'block';
    } else {
        msg.innerHTML = `<strong>QUEST COMPLETE:</strong> You restored order to the Tower! Review your ${gameState.wrongAnswers.length} mistakes below to achieve perfection next time.`;
        document.getElementById('perfect-run-bonus').style.display = 'none';
    }
    reviewContent.appendChild(msg);

    // 4. Mistakes Review
    if (gameState.wrongAnswers.length > 0) {
        gameState.wrongAnswers.forEach(item => {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <p style="margin-bottom: 5px;"><strong>Question:</strong> ${item.q}</p>
                <p class="correct-answer" style="margin-top: 0;">ðŸ’¡ <em>${item.explanation}</em></p>
            `;
            reviewContent.appendChild(div);
        });
    }

    UI.update();
},

    showInfo: (text) => {
        gameState.gameMode = 'modal';
        document.getElementById('info-text').textContent = text;
        document.getElementById('close-info-button').onclick = UI.closeModals;
        UI.update();
    },
    showLevelSelect: () => {
        gameState.gameMode = 'modal';
        const { level } = gameState.player;
        document.getElementById('goto-ground-button').style.display = level !== 'ground' ? 'block' : 'none';
        document.getElementById('goto-sky-button').style.display = level !== 'sky' ? 'block' : 'none';
        document.getElementById('goto-depths-button').style.display = level !== 'depths' ? 'block' : 'none';
        document.getElementById('level-select-modal').classList.add('visible');
    },
    showCodex: () => {
        gameState.gameMode = 'codex';
        
        // Safety check to prevent error if database isn't loaded
        if (!DATABASE.codex) return;

        const list = document.getElementById('codex-list');
        const content = document.getElementById('codex-content');
        list.innerHTML = '';
        content.innerHTML = '<h3>Select an entry to read.</h3>';

        Object.keys(DATABASE.codex).forEach(key => {
            const entry = DATABASE.codex[key];
            const item = document.createElement('div');
            item.className = 'codex-item';
            item.textContent = entry.title;
            
            if (gameState.unlockedCodexEntries.includes(key)) {
                item.classList.add('codex-unlocked');
                item.onclick = () => UI.displayCodexEntry(key);
            } else {
                item.classList.add('codex-locked');
                item.textContent += " (Locked)";
            }
            list.appendChild(item);
        });
        UI.update();
    },
    displayCodexEntry: (key) => {
        const entry = DATABASE.codex[key];
        const content = document.getElementById('codex-content');
        let examplesHtml = '<ul>';
        entry.examples.forEach(ex => {
            examplesHtml += `<li>${ex}</li>`;
        });
        examplesHtml += '</ul>';

        content.innerHTML = `
            <h3>${entry.title}</h3>
            <p>${entry.description}</p>
            <h4>Examples:</h4>
            ${examplesHtml}
        `;
    }
};

// ADD THE DEFINITION ABOVE ANIMATE (Around line 383)
function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.position.add(p.userData.velocity);
        p.material.opacity -= 0.02;
        if (p.material.opacity <= 0) {
            scene.remove(p);
            particles.splice(i, 1);
        }
    }
}

function animate() {
    requestAnimationFrame(animate);
    
    // 1. UI and Stats Update
    if (gameState.gameMode !== 'won' && gameState.startTime) {
        UI.updateUI();
    }
    
    // 2. Bobbing & Spinning Quills
    collectiblesGroup.children.forEach(quill => {
        quill.rotation.y += 0.05;
        quill.position.y = 5 + Math.sin(Date.now() * 0.003) * 1.5; 
    });

    // 3. Rotating Starfield (Only visible in Sky level)
    if (stars && stars.visible) {
        stars.rotation.y += 0.0001;
    }

    // 4. Particle Update
    if (typeof updateParticles === 'function') {
        updateParticles();
    }

    // 5. Snappy Player Update
    const targetX = gameState.player.x * TILE_SIZE;
    const targetZ = gameState.player.y * TILE_SIZE;
    playerMesh.position.set(targetX, 0, targetZ); 

    // 6. Snappy Player Rotation
    const rotMap = { up: Math.PI, down: 0, left: -Math.PI/2, right: Math.PI/2 };
    playerMesh.rotation.y = rotMap[gameState.player.dir];

    // 7. Fixed Camera Offset
    camera.position.x = playerMesh.position.x;
    camera.position.y = playerMesh.position.y + 80;
    camera.position.z = playerMesh.position.z + 60;
    camera.lookAt(playerMesh.position.x, playerMesh.position.y, playerMesh.position.z);
    
    renderer.render(scene, camera);
}

function initGame() {
    // 1. Starfield Background
    const starGeometry = new THREE.BufferGeometry();
    const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.7 });
    const starVertices = [];
    for (let i = 0; i < 5000; i++) {
        starVertices.push((Math.random() - 0.5) * 2000, (Math.random() - 0.5) * 2000, (Math.random() - 0.5) * 2000);
    }
    starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
    stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);

    // 2. Initialize 3D Lava Sea - RAISED HEIGHT for visibility
    const lavaGeo = new THREE.PlaneGeometry(2000, 2000);
    const lavaMat = new THREE.MeshStandardMaterial({ 
        color: 0xff4400, 
        emissive: 0xaa2200, 
        emissiveIntensity: 0.8,
        roughness: 0.1 
    });
    lavaFloor = new THREE.Mesh(lavaGeo, lavaMat);
    lavaFloor.rotation.x = -Math.PI / 2;
    lavaFloor.position.y = -5; // FIX: Raised so students can see it beneath the path
    lavaFloor.visible = false;
    scene.add(lavaFloor);

    World.init();
    gameState.startTime = Date.now();
    
    // 3. Fullscreen Resizing Engine
    const wrapper = document.getElementById('canvas-wrapper');
    if (wrapper) {
        const resizeGame = () => {
            renderer.setSize(wrapper.clientWidth, wrapper.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            camera.aspect = wrapper.clientWidth / wrapper.clientHeight;
            camera.updateProjectionMatrix();
        };
        resizeGame();
        window.addEventListener('resize', resizeGame);
    }

    // 4. Lighting & Player Setup
    scene.add(new THREE.AmbientLight(0xffffff, 0.4), new THREE.DirectionalLight(0xffffff, 0.8));
    Player.init();
    World.loadLevel(gameState.player.level);

    // 5. MASTER DEV UNLOCK FUNCTION
    const devUnlock = () => {
        gameState.elevatorUnlocked = true;
        runtimeLevels['ground'].map[4][8] = TILE_TYPES.BRIDGE;
        runtimeLevels['ground'].map[4][9] = TILE_TYPES.BRIDGE;
        if (gameState.player.level === 'ground') World.loadLevel('ground', true);
        gameState.completedQuizzes = Object.keys(DATABASE.npcs);
        gameState.unlockedCodexEntries = Object.keys(DATABASE.codex);
        UI.updateUI();
        UI.showInfo("DEVELOPER MODE ACTIVE: Bridge Built, Elevator Unlocked, and All 12 Keys Restored!");
    };

    // 6. Click Listener for Dev Trigger
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    canvas.addEventListener('click', (event) => {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(clickableGroup.children);
        if (intersects.length > 0 && intersects[0].object.name === 'dev-trigger') {
            devUnlock();
        }
    });

    // 7. Input Wiring
    document.addEventListener('keydown', (e) => {
        if(gameState.gameMode !== 'explore') return;
        switch(e.key) {
            case 'ArrowUp': case 'w': Player.move(0, -1); break;
            case 'ArrowDown': case 's': Player.move(0, 1); break;
            case 'ArrowLeft': case 'a': Player.move(-1, 0); break;
            case 'ArrowRight': case 'd': Player.move(1, 0); break;
            case 'e': case 'Enter': Player.interact(); break;
        }
    });

    const attachListener = (id, handler) => {
        const el = document.getElementById(id);
        if (el) el.onclick = handler;
    };
    
    const attachTouch = (id, handler) => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('touchstart', (e) => { e.preventDefault(); handler(); }, { passive: false });
            el.addEventListener('mousedown', handler);
        }
    };

    // 8. FIX: Professional Replay Logic (Page Refresh)
    const replayBtn = document.getElementById('play-again-button');
    if (replayBtn) {
        replayBtn.onclick = () => {
            window.location.reload(); 
        };
    }

    // Connect Nav Buttons
    attachListener('talk-button', UI.startQuiz);
    attachListener('close-dialogue-button', UI.closeModals);
    attachListener('exit-quiz-button', UI.closeModals);
    attachListener('instructions-button', () => document.getElementById('instructions-modal').classList.add('visible'));
    attachListener('close-instructions-button', () => document.getElementById('instructions-modal').classList.remove('visible'));
    attachListener('codex-button', UI.showCodex);
    attachListener('close-codex-button', UI.closeModals);

    attachListener('goto-ground-button', () => { gameState.player.level = 'ground'; World.loadLevel('ground'); UI.closeModals(); });
    attachListener('goto-sky-button', () => { gameState.player.level = 'sky'; World.loadLevel('sky'); UI.closeModals(); });
    attachListener('goto-depths-button', () => { gameState.player.level = 'depths'; World.loadLevel('depths'); UI.closeModals(); });
    attachListener('stay-button', UI.closeModals);

    // 9. Mobile D-Pad
    attachTouch('up-btn-ipad', () => Player.move(0, -1));
    attachTouch('down-btn-ipad', () => Player.move(0, 1));
    attachTouch('left-btn-ipad', () => Player.move(-1, 0));
    attachTouch('right-btn-ipad', () => Player.move(1, 0));
    attachTouch('interact-btn-ipad', Player.interact); 

    UI.updateUI();
    animate();
    UI.showInfo("Restore order to the Tower of Marks! Pass all 12 quizzes to defeat Grammarlin.");
}

window.onload = initGame;
</script>
</body>
</html>